<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="袁宇杰（Mi&amp;Jack）在 Github 上的个人博客">
    <meta name="keyword" content="null">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="江湖迈杰的博客" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        代理模式｜Mi&amp;Jack&#39;s blog
        
    </title>

    <link rel="canonical" href="http://mijack.github.io/2018/01/07/代理模式/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('http://ohy7r8bgu.bkt.clouddn.com/background.jpg#博文默认的图片')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    江湖迈杰的博客
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
                        
                    
                        
							
                        <li>
                            <a href="/Tags/">Tags</a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="http://ohy7r8bgu.bkt.clouddn.com/background.jpg#博文默认的图片">


<style>
    
    header.intro-header {
        background-image: url('http://ohy7r8bgu.bkt.clouddn.com/background.jpg#博文默认的图片')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>代理模式</h1>
                    
                    <span class="meta">
                         作者 Mi&Jack
                        <span>
                          日期 2018-01-07
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#设计模式"
                           title="设计模式">设计模式</a>
                        
                        <a class="tag" href="/tags/#代理模式"
                           title="代理模式">代理模式</a>
                        
                        <a class="tag" href="/tags/#CGLib"
                           title="CGLib">CGLib</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            代理模式
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <blockquote>
<p>声明：我已委托「维权骑士」（rightknights.com）为我的文章进行维权行动。</p>
</blockquote>
<h1 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h1><p>代理模式是设计模式中一种常见的设计模式，我们往往通过代理模式可以拦截目标方法的执行，进行自己想要的业务需求，例如日志拦截，权限校验等工作。</p>
<p>代理模式的实现方式如下：</p>
<p><img src="/imgs/代理模式类图.png" alt="代理模式类图"></p>
<p>在代理模式中，我们将类分为以下三类角色</p>
<p>抽象对象Subject，代理对象Proxy，以及真实对象RealSubject。</p>
<p>当我们想要执行某一个动作时，我们不是直接调用RealSubject的方法，而是通过Proxy间接调用RealSubject的方法。为了使Proxy和RealSubject对外界提供功能保持一致，我们定义了一个接口Subject，表示他们可以提供的业务的能力，Proxy和RealSubject均实现了这一个接口，不同的是RealSubject是真正的业务实现，而Proxy只是简单调用了字段subject对应的函数。</p>
<h2 id="代理模式的好处"><a href="#代理模式的好处" class="headerlink" title="代理模式的好处"></a>代理模式的好处</h2><p>代理模式通过引入代理对象这一角色，在一定程度上隔离了业务发起方和业务实际处理方，避免了两者之间的直接交互，在不更改业务执行流程的前提下，为灵活的需求变化提供了可拓展的编码空间。</p>
<h1 id="代理模式的简单实现静态代理"><a href="#代理模式的简单实现——静态代理" class="headerlink" title="代理模式的简单实现——静态代理"></a>代理模式的简单实现——静态代理</h1><p>对应的代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doAction1</span><span class="params">()</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doAction2</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span></span>&#123;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction1</span><span class="params">()</span></span>&#123;</div><div class="line">  	System.out.println(<span class="string">"相关的业务事件 1"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction2</span><span class="params">()</span></span>&#123;</div><div class="line">  	System.out.println(<span class="string">"相关的业务事件 2"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Subject</span></span>&#123;</div><div class="line">  <span class="keyword">private</span> Subject subject;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction1</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(subject!=<span class="keyword">null</span>)&#123;</div><div class="line">      subject.doAction1();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction2</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(subject!=<span class="keyword">null</span>)&#123;</div><div class="line">      subject.doAction2();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实际调用</span></div><div class="line"><span class="comment">// 创建realObject</span></div><div class="line">Subject subject = <span class="keyword">new</span> RealSubject();</div><div class="line"><span class="comment">// 创建代理对象 Proxy object</span></div><div class="line">ProxySubject proxy= <span class="keyword">new</span> ProxySubject();</div><div class="line"><span class="comment">// 绑定代理对象和real object</span></div><div class="line">proxy.setSubject(subject);</div><div class="line"><span class="comment">// 调用Proxy的业务方法</span></div><div class="line">proxy.doAction1();</div></pre></td></tr></table></figure>
<p>上述代码就是传说中的静态代理模式。</p>
<h2 id="静态代理的弊端"><a href="#静态代理的弊端" class="headerlink" title="静态代理的弊端"></a>静态代理的弊端</h2><p>但是，这样的静态代理模式虽然实现起来简单，但是存在着很多弊端：</p>
<ul>
<li>代理者使用了业务接口，因此需要<strong>实现接口中声明的所有方法</strong> ：当一个接口中定义了100个甚至更多的方法时，我们需要实现相应数量的方法。如果是好几个接口，那这个工作量可想而知；</li>
<li><strong>业务逻辑的关注点分散在类中的各个方法中</strong> ，增加了类功能维护的成本：我们如果想实现一个功能，但方法开始执行时，输出对应的日志信息。如果通过现有实现方式，代理对象的每个方法中我们都要调用对应的日志函数，工作量很大；另外，如果那一天，我们希望改下部分方法的处理逻辑，工作量依旧存在。</li>
</ul>
<p>换而言之，静态代理的弊端就在于<strong>代理对象没有对真实对象的动作行为做抽象处理，无形之中增加了程序逻辑修改带来的维护成本</strong> 。</p>
<h1 id="jdk中的动态代理"><a href="#JDK中的动态代理" class="headerlink" title="JDK中的动态代理"></a>JDK中的动态代理</h1><p>为了解决上述问题，我们需要用到JDK中提供的动态代理API。具体API实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Subject proxy = (Subject) Proxy.newProxyInstance(</div><div class="line">        <span class="comment">// 生成的字节码由该ClassLoader加载到虚拟器中</span></div><div class="line">        ClassLoader.getSystemClassLoader(),</div><div class="line">        <span class="comment">// 需要代理的接口，是一个数组，可以代理多个对象</span></div><div class="line">        <span class="keyword">new</span> Class[]&#123;Subject.class&#125;,</div><div class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">            <span class="comment">// 代理对象的代理的真实对象</span></div><div class="line">            Subject subject = <span class="keyword">new</span> RealSubject();</div><div class="line"></div><div class="line">          <span class="comment">/**</span></div><div class="line">           * <span class="doctag">@param</span> proxy 系统生成的代理对象实例</div><div class="line">           * <span class="doctag">@param</span> method 客户端调用的目标方法的方法对象</div><div class="line">           * <span class="doctag">@param</span> args 客户端调用目标方法时传入的参数</div><div class="line">           * <span class="doctag">@return</span></div><div class="line">           * <span class="doctag">@throws</span> Throwable</div><div class="line">           */</div><div class="line">          <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="comment">// 调用前的逻辑</span></div><div class="line">                <span class="comment">// 调用代理对象的相关方法</span></div><div class="line">                Object result = method.invoke(subject, args);</div><div class="line">                <span class="comment">// 调用后的逻辑</span></div><div class="line">                <span class="comment">// 返回处理结果</span></div><div class="line">                <span class="keyword">return</span> result;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"><span class="comment">// 调用代理对象的相关方法</span></div><div class="line">proxy.doAction1();</div></pre></td></tr></table></figure>
<h2 id="动态代理的实现原理"><a href="#动态代理的实现原理" class="headerlink" title="动态代理的实现原理"></a>动态代理的实现原理</h2><p>JDK中的动态代理通过<strong>字节码生成</strong> 技术，产生<strong>目标代理对象</strong> ，将用户对目标接口的方法调用<strong>统一路由到特定的接口</strong> <code>java.lang.reflect.InvocationHandler</code> ，将客户端发起的调用转化成一一对应的Method对象，实现了代理动作的<strong>抽象</strong> ，实现代理的目的。</p>
<h2 id="生成的代理类"><a href="#生成的代理类" class="headerlink" title="生成的代理类"></a>生成的代理类</h2><p>通过设置相关的系统属性为true  ，我们可以在磁盘上看到<code>Proxy.newInstance()</code>方法生成的类的字节码文件。<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">System.setProperty(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</div></pre></td></tr></table></figure></p>
<p>例子中生成的代理类如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sun.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m4;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</div><div class="line">        <span class="keyword">super</span>(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</div><div class="line">            <span class="keyword">throw</span> var3;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doAction1</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m4, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doAction2</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, Class.forName(<span class="string">"java.lang.Object"</span>));</div><div class="line">            m4 = Class.forName(<span class="string">"Subject"</span>).getMethod(<span class="string">"doAction1"</span>);</div><div class="line">            m3 = Class.forName(<span class="string">"Subject"</span>).getMethod(<span class="string">"doAction2"</span>);</div><div class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>);</div><div class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>生成代理类有以下特点：</p>
<ul>
<li>该类继承于类java.lang.reflect.Proxy，实现了用户传入的interface数组中的所有接口，是一个final类；</li>
</ul>
<ul>
<li><p>如果代理的接口均为public的，那么代理类就是public的，对应的包名为com.sun.proxy;</p>
</li>
<li><p>如果代理的接口中存在非public接口，那么代理类就是非public的，对应的包名就是非public接口所在的包名;</p>
</li>
<li><p>方法签名重复：</p>
<ul>
<li>如果代理的接口中存在两个及以上的方法持有相同的方法签名，那么这些方法对应的返回类型也必须保持一致，不然对应的代理类型无法生成。</li>
<li>对于方法签名重复的方法，代理类会根据传入的代理接口的顺序将指定目标方法对象为第一个声明该方法签名的接口。</li>
</ul>
</li>
<li><p>代理对象还代理了常见的hashcode、equals、toString等方法。</p>
<blockquote>
<p>注意事项:</p>
<ol>
<li>也正是因为生成的代理类继承了类Proxy，Java不支持类的多继承，所以我们不能通过相同方式实现针对类的动态代理。</li>
<li>方法签名相同是指方法名相同，同时对应位置参数类型也相同，不包含方法的返回类型</li>
</ol>
</blockquote>
</li>
</ul>
<h1 id="动态代理和静态代理的区别"><a href="#动态代理和静态代理的区别" class="headerlink" title="动态代理和静态代理的区别"></a>动态代理和静态代理的区别</h1><h2 id="是否生成新的代码"><a href="#是否生成新的代码" class="headerlink" title="是否生成新的代码"></a>是否生成新的代码</h2><p>静态代理和动态代理最大的区别在于是否产生了新的类：</p>
<ul>
<li>静态代理中所有的类均是由开发人员编写的；</li>
<li>动态代理中代理类是系统类Proxy的静态方法<code>newProxyInstance()</code>完成，用户无需关心代理类的具体实现，只需要关心如何处理<strong>函数调用的逻辑</strong> ；</li>
<li>方法逻辑的统一处理是动态代理的最大优点：<ul>
<li>两者比较发现，对于动态代理方法，代理类对于开发人员而言是透明的，他们不需要关心代理类中对接口的<strong>底层实现</strong> ，而只需要从方法抽象角度，通过同一个InvocationHandler接口决定每个方法在调用时的具体行为逻辑。</li>
</ul>
</li>
</ul>
<h2 id="两者在时序图的差异"><a href="#两者在时序图的差异" class="headerlink" title="两者在时序图的差异"></a>两者在时序图的差异</h2><p>对比静态代理和动态代理的时序图中，我们可以发现静态代理的调用层数明显比动态代理少很多，而且不包含任何反射行为，在一定程度上执行效率要比动态调用高，但是Proxy和RealObject高度耦合到一起，这种实现方式对开放拓展不利。</p>
<p><img src="/imgs/静态代理时序图.png" alt=""></p>
<p>但是，动态代理中的<code>Proxy</code>通过<code>InvocationHandler</code>对所有的函数调用请求做了统一处理，将所有请求转化成对应的<code>Method</code>对象，减少了<code>InvocationHandler</code>对<code>RealObject</code>的依赖，在一定程度上得到了解耦的目的，实现了</p>
<p><img src="/imgs/动态代理时序图.png" alt=""></p>
<h1 id="代理那些不能被jdk代理的类"><a href="#代理那些不能被JDK代理的类" class="headerlink" title="代理那些不能被JDK代理的类"></a>代理那些不能被JDK代理的类</h1><p>前面我们已经提到由于Proxy生成的新的类继承了类Proxy，而Java不支持类的多继承，所以JDK的动态代理不支持针对类中方法的代理处理。但是，我们可以通过CGLib这个库实现这些类的代理。</p>
<p>例如，我们有一个类StudentService：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">        <span class="comment">// do something</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们想要代理这个类，在save执行前输出user对象，执行后输出存在完成的提示时，通过CGLib的具体实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 获取一个Enhancer对象，以生成新的字节码</span></div><div class="line">Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line"><span class="comment">// 设置目标类的父类</span></div><div class="line">enhancer.setSuperclass(Service.class);</div><div class="line"><span class="comment">// 设置目标函数的回调函数Callback对象</span></div><div class="line">enhancer.setCallback(<span class="keyword">new</span> CglibProxy());</div><div class="line"><span class="comment">// 创建子类并生成对应的代理对象实例</span></div><div class="line">Service service = (Service) enhancer.create();</div><div class="line"><span class="comment">// 调用目标函数</span></div><div class="line">service.save(<span class="keyword">new</span> User());</div></pre></td></tr></table></figure>
<p>其中CGLibProxy的实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, </span></span></div><div class="line">                            Object[] objects, MethodProxy methodProxy) <span class="keyword">throws</span> Throwable &#123;</div><div class="line">        System.out.println(objects[<span class="number">0</span>]);</div><div class="line">        Object result = methodProxy.invokeSuper(o, objects);</div><div class="line">        System.out.println(<span class="string">"打印结束"</span>);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="cglib中的那些callback"><a href="#CGlib中的那些callback" class="headerlink" title="CGlib中的那些callback"></a>CGlib中的那些callback</h2><p>CGLib提供了很多Callback实现，MethodInterceptor只是其中的一个实现，其他的还有<code>NoOp</code>、<code>LazyLoader</code>、<code>Dispatcher</code> 、<code>InvocationHandler</code> 、<code>FixedValue</code>、<code>ProxyRefDispatcher</code>。他们的具体含义如下</p>
<ul>
<li>MethodInterceptor：全权代理所有方法的调用执行。</li>
<li>NoOp：无额外逻辑，把方法调用直接委派到父类中的实现。</li>
<li>LazyLoader：被代理的对象需要懒加载</li>
<li>Dispatcher：将方法调用转发到特定的对象的方法上</li>
<li>InvocationHandler：JDK中InvocationHandler在GCLib的实现，可以代理类中的方法</li>
<li>FixedValue：对于特定方法，强制返回特定的值，常和CallbackFilter结合使用</li>
<li>ProxyRefDispatcher：和Dispatcher作用相同，不同的是ProxyRefDispatcher可以找到代理对象。</li>
</ul>
<h2 id="callbackfilter"><a href="#CallbackFilter" class="headerlink" title="CallbackFilter"></a>CallbackFilter</h2><p>在上面例子里，我们采用了是MethodIntercepter，实际上，Enhancer支持多个Callback，我们可以通过CallbackFilter指派每一个方法的代理模式采用哪一种Callback。当然，这种指定关系是<strong>生成的字节码</strong>中方法的代理模式，是一种静态关系绑定，不是动态的。</p>
<p>具体代理实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 获取一个Enhancer对象，以生成新的字节码</span></div><div class="line">Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line"><span class="comment">// 设置目标类的父类</span></div><div class="line">enhancer.setSuperclass(Service.class);</div><div class="line">Callback[] callbacks = <span class="keyword">new</span> Callback[]&#123;<span class="keyword">new</span> CglibProxy(), NoOp.INSTANCE&#125;;</div><div class="line"><span class="comment">// 设置目标函数的回调函数Callback对象数组</span></div><div class="line">enhancer.setCallbacks(callbacks); <span class="comment">// 指定代理类需要用到的所有的Callback，是一个数组</span></div><div class="line"><span class="comment">// 设置CallbackFilter</span></div><div class="line">enhancer.setCallbackFilter(<span class="keyword">new</span> CallbackFilter() &#123; </div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(Method method)</span> </span>&#123;<span class="comment">// 根据特定的方法返回对应的代理位置</span></div><div class="line">    <span class="keyword">if</span> (method.getName().equals(<span class="string">"query"</span>)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="number">1</span>;<span class="comment">// =&gt; 对应的Callback数组的第1位</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// =&gt; 对应的Callback数组的第0位</span></div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>参考资料：</p>
<ul>
<li><a href="http://www.cnblogs.com/shijiaqi1066/p/3429691.html" target="_blank" rel="external">CGLib学习笔记</a></li>
</ul>

                <hr>
                

                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2017/12/25/二叉树的遍历算法/" data-toggle="tooltip" data-placement="top"
                           title="二叉树的遍历算法">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#代理模式"><span class="toc-text">代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#代理模式的好处"><span class="toc-text">代理模式的好处</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代理模式的简单实现静态代理"><span class="toc-text">代理模式的简单实现——静态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#静态代理的弊端"><span class="toc-text">静态代理的弊端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jdk中的动态代理"><span class="toc-text">JDK中的动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#动态代理的实现原理"><span class="toc-text">动态代理的实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生成的代理类"><span class="toc-text">生成的代理类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动态代理和静态代理的区别"><span class="toc-text">动态代理和静态代理的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#是否生成新的代码"><span class="toc-text">是否生成新的代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#两者在时序图的差异"><span class="toc-text">两者在时序图的差异</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代理那些不能被jdk代理的类"><span class="toc-text">代理那些不能被JDK代理的类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cglib中的那些callback"><span class="toc-text">CGlib中的那些callback</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#callbackfilter"><span class="toc-text">CallbackFilter</span></a></li></ol></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#设计模式"
                           title="设计模式">设计模式</a>
                        
                        <a class="tag" href="/tags/#代理模式"
                           title="代理模式">代理模式</a>
                        
                        <a class="tag" href="/tags/#CGLib"
                           title="CGLib">CGLib</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <div style="margin-top: 20px;">
                    <h5 class="text-center">FRIENDS</h5>
                    <ul class="list-inline text-center">
                        
                        <li><a href="http://chih.me">chih</a></li>
                        
                        <li><a href="https://buwenqi.github.io">wenqi</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>

    </div>
</article>






<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/mijackstudio">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/mijackstudio">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/mijack">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 江湖迈杰的博客 2018
                    <br>
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> Times</span>
                    <br>
                    Theme by <a href="https://haojen.github.io/">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://mijack.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-75651210- 1';
    var _gaDomain = 'auto';
    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>


<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','null','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="https://avatars.githubusercontent.com/u/4158061?v=3">
</body>

</html>
