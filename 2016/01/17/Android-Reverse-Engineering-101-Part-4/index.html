<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="description">
    <meta name="keywords"  content="Mi&Jack, Mi&Jack Blog, 江湖迈杰的博客, yuanyujie, 袁宇杰, Java, Android">
    <meta name="theme-color" content="#000000">
    
    <title>Android逆向工程101 – Part 4 - 江湖迈杰的博客 | BY Mi&Jack</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2016/01/17/Android-Reverse-Engineering-101-Part-4/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">江湖迈杰的博客</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/bg-head.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/bg-head.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                        <a class="tag" href="/tags/#逆向工程" title="逆向工程">逆向工程</a>
                        
                    </div>
                    <h1>Android逆向工程101 – Part 4</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by Mi&Jack on January 17, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<p>在Android应用逆向工程的系列博客中，我们已经讨论过了<a href="http://www.fasteque.com/android-reverse-engineering-101-part-1/">APK的文件格式</a>, <a href="http://www.fasteque.com/android-reverse-engineering-101-part-2/">aapt</a> 和 <a href="http://www.fasteque.com/android-reverse-engineering-101-part-3/">dex2jar</a>，接下来我们介绍<strong>Apktool</strong>。</p>

<p>我们都知道，APK的资源文件是经过压缩以二进制的格式存储在文件中，我们无法通过<strong>aapt</strong>和<strong>dex2jar</strong>对其进行查看和编辑，前者实质是一个读取工具，用于从apk中提取有用的信息；而后者只能帮助我们获取到Apk中的执行代码并不能获取资源文件。</p>

<p>下面是摘抄自Apktool的<a href="https://ibotpeaches.github.io/Apktool/">官方网站</a>:</p>

<blockquote>
  <p>一种用于逆向第三方闭源Android工程的工具，它可以反编译出和源文件形式相似的资源文件，并对其进行修改、重打包。可以对Smail代码进行单步调试。因为项目结构和开发时的较为相近以及自身所带的Apk构建等自动化操作，这让开发应用更加方便。</p>
</blockquote>

<p>所以，这个工具是逆向工程的必备工具，因为它能对资源进行解码。</p>

<p>这里需要注意的是，记住，它<strong>不能</strong>用于涉及隐私或者其他非法的用途。</p>

<h2 id="安装">安装</h2>

<p><a href="http://ibotpeaches.github.io/apktool/install/">这个网站</a>是关于如何安装的详细介绍。只需要检查一下Java版本，去环境说明章节看一下对应的平台（Window，Linux，Mac OS X）上的说明。</p>

<p>本文使用的 <strong>Apktool</strong> 的版本是 <code class="highlighter-rouge">v2.0.2</code>.</p>

<p>按照说明正确安装设置后，我们在命令行中输入<code class="highlighter-rouge">apktool</code>,得到如下输出：</p>

<p><img src="http://i1.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screen-Shot-2015-11-23-at-22.11.54.png" alt="" /></p>

<p>在输入第一个命令之前，我们需要选择一个应用。在之前介绍<a href="http://www.fasteque.com/android-reverse-engineering-101-part-3/"><strong>dex2jar article</strong></a>，我选择了<a href="https://play.google.com/store/apps/details?id=com.fastebro.androidrgbtool">RGB Tool</a> ，因为它是我的一个开源项目，对其进行逆向工程并不会有任何争议。我们可以在<a href="https://play.google.com/store/apps/details?id=com.fastebro.androidrgbtool">这里</a>下载这个该应用。</p>

<p>对于所有的实例，均运行在我的<strong>Nexus 6</strong>上，安装有<strong>RGB Tool v1.4.3</strong> ，系统版本<strong>Android 6.0</strong>。</p>

<h2 id="frameworks">FRAMEWORKS</h2>

<p>在反编译APK或者系统应用的过程中，Frameworks是非常重要的。事实上，在一台设备或者模拟器上，有一APK文件包括了ROM里的所有资源，包括图片、动画、声音、闪屏等，它是系统镜像的一部分.</p>

<p>这个文件位于<code class="highlighter-rouge">/system/framework/framework-res.apk</code></p>

<p>简单的讲，这个文件包括关于设备界面风格所需的必要资源，被系统获取其他应用使用。对于任何一个制造商，包括三星，HTC，摩托罗拉，LG等，它都会提供自己的frameworkd的APK文件。</p>

<p>Apktool默认情况下使用的是AOSP的framework，并在如下路径（Mac OS X）有对应文件的拷贝:<code class="highlighter-rouge">$HOME/Library/apktool/framework/1.apk</code></p>

<p>如果我们需要反编译基于一个另外的Framework系统的应用，我们可能安需要装它，否则我们会得到下面的错误：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W: Could not decode attr value, using undecoded value instead: ns=android, name=drawable
W: Could not decode attr value, using undecoded value instead: ns=android, name=iconCan't find framework resources for package of id: 2. You must install proper framework files, see project website for more info.
</code></pre></div></div>

<p>第一件事情就是使用<code class="highlighter-rouge">adb pull</code>从设备中导出framework的APK文件，一般情况下，我们可以在<code class="highlighter-rouge">/system/framework</code>找到它, 如果还是找不到它，可以在 <a href="http://ibotpeaches.github.io/Apktool/documentation/#framework-files">该网站</a>查看所有可能的路径。</p>

<p>然后，我们可以安装它： <code class="highlighter-rouge">apktool if FRAMEWORK.apk</code></p>

<p>在执行完这步操作后，我们可以反编译系统应用了。</p>

<p><strong>Note</strong>: 本文的后续章节使用的是默认的AOSP framework，所以无需重新安装。</p>

<h2 id="反编译">反编译</h2>

<p>运行如下命令，就可以反编译APK文件：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apktool d FILENAME.apk
</code></pre></div></div>

<p><img src="http://i0.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screen-Shot-2015-11-23-at-22.45.01.png" alt="apktool decode" /></p>

<p>工具创建了一个文件夹，并在反编译好APK后对其进行重命名。</p>

<p><img src="http://i0.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screen-Shot-2015-11-25-at-21.29.38.png?resize=1024%2C218" alt="apktool decode output" /></p>

<p>apktool 反编译的输出</p>

<p>请注意,输出文件夹的内容取决于APK文件以及其包含的文件。</p>

<p>首先要注意的是<code class="highlighter-rouge">apktool.yml</code>文件：它包含重要的信息,如应用<strong>版本名称</strong>、<strong>代码</strong>、<strong>最小和支持SDK版本</strong>…当我们重新构建APK文件的时候，此文件是必需的,特别如果我们想改变其中的某个值。</p>

<p>我们有了XML格式的<code class="highlighter-rouge">AndroidManifest.xml</code>文件, <strong>并不是二进制格式</strong>, 所以我们可以对其进行浏览和编辑。</p>

<p><code class="highlighter-rouge">original</code>文件夹通常包含<code class="highlighter-rouge">AndroidManifest. xml</code>二进制格式文件和含有JAR文件清单和apk签名的<code class="highlighter-rouge">META-INF</code>文件夹。基本上，这两项是直接从apk里复制得到的，没有做过修改。</p>

<p><code class="highlighter-rouge">Smali</code>文件夹包含了应用程序中Smali格式的源代码：<a href="HTTP：/ / www.fasteque。COM / android-reverse-engineering-101-part-3 /">在我以前的文章</a>，已经讨论过这一点了，所以我只提到几件事。首先，代码的目录结构是依据包名。从中我们可以得到所有的可执行代码，其中包括来自第三方依赖的代码也在这个文件夹中。其次，我们可以对其进行修改，并对其进行重打包操作，形成新的APK文件。</p>

<p>最后一个文件夹是<code class="highlighter-rouge">res</code>，很明显，这是资源文件夹：<strong>apktool</strong> 能反编译以【二进制形式](http://www.fasteque.com/android-reverse-engineering-101-part-1/)存储在<code class="highlighter-rouge">resources.arsc</code>中的资源，所以我们可以看到，当然也可以修改他们。这里有一个重要的事情：因为我们解码是运行在设备里的apk文件，所以，程序所有依赖的资源文件均在这个文件夹中，所以不必惊讶得到的资源文件比我们在Android Studio中看到的还要多。说明一点，在开发时我们使用了<strong>AppCompat V7</strong>这个库作为其中的一个依赖，所以我们理所应当得到他的资源文件(它们的文件名以<code class="highlighter-rouge">abc_</code>开头)。</p>

<p>最后要注意的是，资源文件的子文件夹的名称不一定和项目或原有的应用的对应文件夹完全匹配，这样设计主要是为了apktool能够将这些资源重新打包，构建一个可以运行的APK。</p>

<h2 id="构建">构建</h2>

<p>使用如下命令就可以进行构建操作：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apktool b APKTOOL_DECODE_OUTPUT_DIR
</code></pre></div></div>

<p>Apktool会根据反编译的输出文件夹进行重打包，将对应的APK文件放置在<code class="highlighter-rouge">APKTOOL_DECODE_OUTPUT_DIR/dist</code>路径下。</p>

<p>或者指定对应的APK路径：
<img src="http://i1.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screen-Shot-2015-11-25-at-22.47.35.png" alt="apktool build" />
apktool build</p>

<p><img src="http://i0.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screen-Shot-2015-11-25-at-22.48.26.png" alt="apktool build output" />
apktool build output</p>

<p>请注意，如果Apktool构建的APK没有对应的签名，它将无法安装设备上。</p>

<p>事实上，如果我们直接安装<code class="highlighter-rouge">dist</code>目录下的APK文件，我们会得到如下错误：</p>

<p><img src="http://i1.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screen-Shot-2015-11-26-at-20.29.06.png" alt="APK not signed error" />
APK not signed error</p>

<p>所以，在安装以前，我们需要使用如下命令对其进行签名（他会向我们提示输入密码和keystore）:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore my_application.apk alias_name
</code></pre></div></div>

<p>如果这不是一个发布版本中，我们可以使用用于调试的keystore，使用方法和使用Android Studio一样，keystore文件位于一个隐藏文件夹中（用户文件夹取决于对应的平台环境）：</p>

<p><code class="highlighter-rouge">USER_HOME/.android/debug.keystore</code></p>

<p>Keystore的password是 <code class="highlighter-rouge">android</code>, key alias 是 <code class="highlighter-rouge">androiddebugkey</code> .</p>

<p>除此以外，我们还可以创建属于自己的keystore，请参考<a href="http://developer.android.com/tools/publishing/app-signing.html#signing-manually">官方文档</a> (同时，他建议我们<strong>在签名以后对APK进行zipalign</strong>).</p>

<h2 id="牛刀小试">牛刀小试</h2>

<p>现在，我们已经知道了如何对一个应用进行反编译和重打包，我们对应用做一些小的尝试，感受一下<strong>ApkTool</strong>的特性。</p>

<p>首先，我们来看一下应用原来的主界面，方便通过对比得出我们所做的修改。</p>

<p><img src="http://i1.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screenshot_20151126-204826.png" alt="RGB Tool original main view" />
RGB Tool original main view</p>

<h2 id="应用的名称和主题">应用的名称和主题</h2>

<p>首先，我们来修改一下应用的名称和主题色。</p>

<p>查看manifest文件, 我们发现应用的名称使用的是名为<code class="highlighter-rouge">app_name</code>的string 资源. 所以打开<code class="highlighter-rouge">values/string.xml</code>文件，将对应的值从 <strong>RGB Tool</strong> 改为 <strong>MyRGB Tool</strong>.</p>

<p>关于主题的颜色，让我们再看看manifest文件，确认主题设置在应用层：它是<code class="highlighter-rouge"> Theme.Rgbtool</code>。我们可以在<code class="highlighter-rouge">values/styles.xml</code>中找到它的声明，我们对如下部分比较感兴趣：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;item name="colorPrimary"&gt;@color/primary&lt;/item&gt;
&lt;item name="colorPrimaryDark"&gt;@color/primary_dark&lt;/item&gt;
&lt;item name="colorAccent"&gt;@color/accent&lt;/item&gt;
</code></pre></div></div>

<p>所以，我们将视线转移到<code class="highlighter-rouge">values/colors.xml</code>，更改其中的颜色。关于在主题色的选择，我建议使用<a href="http://www.materialpalette.com/">Material Palette</a>。</p>

<p>我定义了如下新的颜色：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;color name="primary"&gt;#4CAF50&lt;/color&gt;
&lt;color name="primary_dark"&gt;#388E3C&lt;/color&gt;
&lt;color name="accent"&gt;#FFC107&lt;/color&gt;
</code></pre></div></div>

<p>让我们来构建、签名apk。记住我们必须卸载已经安装好的应用，即便是覆盖安装也是这样。</p>

<p>[]Modified RGB Tool](http://i0.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screenshot_20151126-212522.png)
Modified RGB Tool</p>

<h2 id="应用的图标">应用的图标</h2>

<p>我们可以通过和之前同样的方法更改应用程序的图标，因为我们知道那只是一个drawable PNG文件，它的名字是设置在manifest文件中了。所以，我们要做的变化很小，事实上它只需要更新成新的PNG文件（在这里不考虑屏幕密度）并重新生成apk文件。</p>

<p>在这里，图标设置成<code class="highlighter-rouge">@mipmap/ic_launcher</code></p>

<p>我们将使用<a href="http://jgilfelt.github.io/AndroidAssetStudio/index.html">Android Asset Studio</a>, 来生成新的启动图标，打开网页，选择<strong>Launcher icons</strong>。</p>

<p>更新了新的PNG文件后，我们通过打包签名得到APK文件，新的应用图标展现在启动器上：</p>

<p><img src="http://i1.wp.com/www.fasteque.com/wp-content/uploads/2015/11/myrgb_tool_icon.png" alt="New application icon" />
New application icon</p>

<h3 id="新的资源">新的资源</h3>

<p>到目前为止，我们只是替换同名的资源。如果，我们需要向应用添加新的资源，应该如何处理？我们来做一下这方面的尝试。</p>

<p>我们打开应用，减小opacity（O）的值，我们可以看见背景里的Android机器人。</p>

<p><img src="http://i1.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screenshot_20151127-205409.png" alt="RGB Tool android" />
RGB Tool android</p>

<p>它对应的资源是<code class="highlighter-rouge">@drawable/robot</code>，有很多界面使用了它。我们把它提取出来，改改颜色后，命名为<code class="highlighter-rouge">robot_apktool</code>。然后，我们必须在所有的XML布局中的<code class="highlighter-rouge">robot</code>替换成<code class="highlighter-rouge">robot_apktool</code>。然后我们重新打包、签名、安装在我们的设备。</p>

<p><img src="http://i0.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screenshot_20151127-211610.png" alt="New robot" />
New robot</p>

<p>我们的新Android替换好了！说实话，这很容易，因为资源只被XML文件引用，但从未在任何java类出现过。后者和前者属于两种不同的情况，这也是我们不在这里讨论的原因。</p>

<h3 id="我们可以修改源代码吗">我们可以修改源代码吗？</h3>

<p>当然，在文章的开头我们已经介绍过了，<strong>Apktool</strong> 可以反编译出应用的可执行代码，产生<code class="highlighter-rouge">.smali</code>文件,所以我们可以直接更改它们，并生成新的APK文件。当然，
<a href="https://github.com/jesusfreke/smali">Smail</a>并不及java那样容易入门，它的语法比较冗长。我们可以用任何文本编辑器打开这些文件，但是我们无法享受语法高亮和自动完成的编辑器特征。另一方面，我们可以很容易地用grep搜索字符串。</p>

<p>在这里推荐一些工具：一个是开源的<a href="https://github.com/ShaneWilton/sublime-smali">syntax highlighter</a>，而另一个是[全功能的解决方案]（http://virtuous-ten-studio.com/），不仅仅可以用来编辑<code class="highlighter-rouge">smali</code>。</p>

<p>让我们通过smali尝试一个很简单的改变：如果我们点击 <strong>Print color</strong> 选项（需要点击溢出菜单图标调出它），下面的对话框出现在屏幕上。</p>

<p><img src="http://i2.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screenshot_20151127-214535.png?resize=169%2C300" alt="" /></p>

<p>我们要做的是改变按钮文本从<strong>Skip</strong>改为 <strong>Apktool</strong>：在这个例子中，字符串资源用于java类,没有被XML资源文件引用。</p>

<p>资源文件的名称是<code class="highlighter-rouge">action_common_skip</code>，所以我们在<code class="highlighter-rouge">res/values/strings.xml</code>中创建了<code class="highlighter-rouge">action_common_skip_apktool</code>的字符串. 整理还有意大利语和法语的资源。但是在这里，只要修改默认值即可。</p>

<p>现在，我们搜索一下<code class="highlighter-rouge">action_common_skip</code>, 我们将在<code class="highlighter-rouge">public.xml</code>中找到3个String资源(默认，意大利语，法语)。比较有意思的是，我们在Smali文件中找不到搜索结果。查看<a href="https://github.com/fasteque/rgb-tool/blob/master/android-rgb-tool/src/main/java/com/fastebro/androidrgbtool/fragments/PrintJobDialogFragment.java">Java 类</a>,我都知道源代码中确实有用到这个String资源，所以，我打开xml文件和对话框对应的smali文件, <code class="highlighter-rouge">PrintJobDialogFragment.smali</code>.</p>

<p><code class="highlighter-rouge">public.xml</code>是应用程序的所有资源的列表，如字符串、布局、图片、色彩等。每个资源对应十六进制的ID。这些ID实际上是R.java文件中的值。而R文件是我们在创建项目时由Android构建系统帮助我们生成的：没错，apktool在提取APK资源和反编译代码时创建的。正如在这个系列中<a href="http://www.fasteque.com/android-reverse-engineering-101-part-3/">前面的文章</a>所提到的，如果我们在Java类引用资源，比如Activity，它实际上是一个存储在R.java类中的整形ID。</p>

<p>所以，我们在smali文件中查找如下的资源id：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;public type="string" name="action_common_skip" id="0x7f070017" /&gt;
</code></pre></div></div>

<p>有趣的事又来了！他其实引用了（请注意，使用不同的应用或者通过克隆仓库构建新的APK，可能得到和例子中不一样的ID值）：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const v2, 0x7f070017

invoke-virtual {p0, v2}, Lcom/fastebro/androidrgbtool/fragments/PrintJobDialogFragment;-&gt;a(I)Ljava/lang/String;

move-result-object v2
</code></pre></div></div>

<p>ID的值存储在常量 <strong>V2</strong> 中，然后作为一个虚拟方法调用的参数（这将是<code class="highlighter-rouge">setTitle </code>）。操作码汇总列表请看<a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html">这里</a>。</p>

<p>现在，我们理清了这些：我们知道我们必须更新<code class="highlighter-rouge">public.xml</code>文件，加入我们新定义的字符串，并在smali文件设置对应的ID值。</p>

<p>对于第一步，我们注意很多细节：我们可以注意到，资源类型和 <strong>id</strong> 是连续的，一个所以我们不能随意设置ID值。我们需要寻找最后一个字符串资源，然后添加新的字符串资源，<strong>ID</strong> 值在其基础上加1（记得那些hexacedimal值）。在这个例子中，最后一个字符串是<code class="highlighter-rouge">0x7f070051</code> ,需要添加的<strong>id</strong>如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;public type="string" name="action_common_skip_apktool" id="0x7f070052" /&gt;
</code></pre></div></div>

<p>第二步比起第一步简单很多。只需要将<code class="highlighter-rouge">PrintJobDialogFragment.smali</code>中的值改成新的就可以了.</p>

<p>现在，我们重新打包，签名，安装新的APK：界面里展示就是新的字符串了。</p>

<p><img src="http://i0.wp.com/www.fasteque.com/wp-content/uploads/2015/11/Screenshot_20151129-115055.png" alt="New string resource" />
New string resource</p>

<p>这次更新主要介绍了 <strong>apktool</strong> 的主要特点：我鼓励你用它试验使用你开发的APK。它很容易帮助你理解资源如何解码以及阅读smali代码。根据你的需求和应用的版本，对APK进行修改和重建。</p>

<p>在<a href="http://www.fasteque.com/android-reverse-engineering-101-part-5/">下一个章节</a>，我将介绍Androguard.</p>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/01/17/Android-Reverse-Engineering-101-Part-2/" data-toggle="tooltip" data-placement="top" title="Android逆向工程101 – Part 2">
                        Previous<br>
                        <span>Android逆向工程101 – Part 2</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/01/17/Android-Reverse-Engineering-101-Part-5/" data-toggle="tooltip" data-placement="top" title="Android逆向工程101 – Part 5">
                        Next<br>
                        <span>Android逆向工程101 – Part 5</span>
                        </a>
                    </li>
                    
                </ul>


                <!--Gitalk评论start  -->
                
                <!-- 引入Gitalk评论插件  -->
                <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
                <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
                <div id="gitalk-container"></div>
                <script type="text/javascript">
                    var gitalk = new Gitalk({
                    clientID: '0c25cf406e1d9c0165bb',
                    clientSecret: 'a9b973d400e04404eaebe31751812562019fc909',
                    repo: 'mijack.github.io',
                    owner: 'mijack',
                    admin: ['mijack'],
                    distractionFreeMode: true,
                    id: window.location.pathname,
                    });
                    gitalk.render('gitalk-container');
                </script>
                
                <!-- Gitalk end -->

                

            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#Android" title="Android" rel="12">
                                    Android
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#逆向工程" title="逆向工程" rel="4">
                                    逆向工程
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://chih.me/">chih</a></li>
                    
                        <li><a href="https://buwenqi.github.io/">wenqi</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <!-- add jianshu add target = "_blank" to <a> by BY -->
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/mijackstudio">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/github">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Mi&Jack 2018
                    <br>
                    Theme on <a href="https://github.com/mijack/mijack.github.io.git">GitHub</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=github&repo=github.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script type="text/javascript">
    if(navigator.serviceWorker){
        // For security reasons, a service worker can only control the pages that are in the same directory level or below it. That's why we put sw.js at ROOT level.
        navigator.serviceWorker
            .register('/sw.js')
            .then((registration) => {console.log('Service Worker Registered. ', registration)})
            .catch((error) => {console.log('ServiceWorker registration failed: ', error)})
    }
</script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/ 
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers   
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-75651210-1';
    var _gaDomain = 'mijack.github.io';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
